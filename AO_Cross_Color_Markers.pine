// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ao-cross-color-marker-tv

//@version=6
indicator("AO Cross & Color Markers", overlay = true, max_lines_count = 500)

// --- Inputs ---
showZeroCross  = input.bool(true, "Show Zero Cross (0)")
showColorChange = input.bool(true, "Show Color Change (C)")
markerColor    = input.color(color.orange, "Marker Color")

// size parameter of plotchar() requires a compile-time constant,
// so we expose it as a set of bool inputs (only one should be true)
useTiny   = input.bool(false, "Size: Tiny")
useNormal = input.bool(false, "Size: Normal")
useLarge  = input.bool(false, "Size: Large")
useHuge   = input.bool(false, "Size: Huge")

aoAvgLen     = input.int(100, "AO Average Lookback", minval = 10)

showVLines   = input.bool(true, "Show Vertical Lines (C+21, C+34)")
vline21Color = input.color(color.aqua, "VLine 21 Color")
vline34Color = input.color(color.fuchsia, "VLine 34 Color")
vlineStyleIn = input.string("dashed", "VLine Style", options = ["solid", "dashed", "dotted"])

lineStyle = switch vlineStyleIn
    "solid"  => line.style_solid
    "dashed" => line.style_dashed
    "dotted" => line.style_dotted

// --- AO Calculation ---
ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)

// --- Zero Cross Signal ---
// AO crossed zero between bar [2] and bar [1] (last closed bar)
zeroCross = (ao[1] > 0 and ao[2] <= 0) or (ao[1] < 0 and ao[2] >= 0)

// --- AO Average (separate for positive / negative) ---
sumPos = 0.0
cntPos = 0
sumNeg = 0.0
cntNeg = 0
for i = 1 to aoAvgLen
    val = ao[i]
    if not na(val)
        if val > 0
            sumPos += val
            cntPos += 1
        else if val < 0
            sumNeg += val
            cntNeg += 1

avgPos = cntPos > 0 ? sumPos / cntPos : na
avgNeg = cntNeg > 0 ? sumNeg / cntNeg : na

// --- Color Change Signal ---
// AO bar color: green when rising (ao > prev ao), red when falling
colorNow  = ao[1] > ao[2] ? 1 : ao[1] < ao[2] ? -1 : 0
colorPrev = ao[2] > ao[3] ? 1 : ao[2] < ao[3] ? -1 : 0
colorChangeRaw = colorNow != colorPrev and colorNow != 0 and colorPrev != 0

aoAtC   = ao[1]
strongC = false
if aoAtC > 0 and not na(avgPos)
    strongC := math.abs(aoAtC) >= math.abs(avgPos)
else if aoAtC < 0 and not na(avgNeg)
    strongC := math.abs(aoAtC) >= math.abs(avgNeg)

colorChange = colorChangeRaw and strongC

// --- Draw Markers ---
// One plotchar per size level; only the matching pair is visible.
// Default is size.small when no size toggle is enabled.
showZero  = showZeroCross and zeroCross
showColor = showColorChange and colorChange

plotchar(useTiny and showZero,                                          char = '0', location = location.belowbar, color = markerColor, size = size.tiny,   title = "Zero Cross (tiny)",   offset = -1)
plotchar(not useTiny and not useNormal and not useLarge and not useHuge and showZero, char = '0', location = location.belowbar, color = markerColor, size = size.small,  title = "Zero Cross (small)",  offset = -1)
plotchar(useNormal and showZero,                                        char = '0', location = location.belowbar, color = markerColor, size = size.normal, title = "Zero Cross (normal)", offset = -1)
plotchar(useLarge and showZero,                                         char = '0', location = location.belowbar, color = markerColor, size = size.large,  title = "Zero Cross (large)",  offset = -1)
plotchar(useHuge and showZero,                                          char = '0', location = location.belowbar, color = markerColor, size = size.huge,   title = "Zero Cross (huge)",   offset = -1)

plotchar(useTiny and showColor,                                          char = 'C', location = location.belowbar, color = markerColor, size = size.tiny,   title = "Color Change (tiny)",   offset = -1)
plotchar(not useTiny and not useNormal and not useLarge and not useHuge and showColor, char = 'C', location = location.belowbar, color = markerColor, size = size.small,  title = "Color Change (small)",  offset = -1)
plotchar(useNormal and showColor,                                        char = 'C', location = location.belowbar, color = markerColor, size = size.normal, title = "Color Change (normal)", offset = -1)
plotchar(useLarge and showColor,                                         char = 'C', location = location.belowbar, color = markerColor, size = size.large,  title = "Color Change (large)",  offset = -1)
plotchar(useHuge and showColor,                                          char = 'C', location = location.belowbar, color = markerColor, size = size.huge,   title = "Color Change (huge)",   offset = -1)

// --- Vertical Lines: C+21 / C+34 ---
var int  lastCBar  = na
var bool cPending  = false
var line vline21   = na
var line vline34   = na
var bool linesLive = false

var array<int> zoneStarts = array.new<int>()
var array<int> zoneEnds   = array.new<int>()

signalBar = bar_index - 1
inZone    = false
zoneCnt   = array.size(zoneStarts)
if zoneCnt > 0
    for i = 0 to zoneCnt - 1
        if signalBar >= array.get(zoneStarts, i) and signalBar <= array.get(zoneEnds, i)
            inZone := true

if not inZone
    if colorChange and not zeroCross
        lastCBar := bar_index - 1
        cPending := true
        linesLive := false
    else if zeroCross and cPending
        cPending := false
        newStart = lastCBar + 21
        newEnd   = lastCBar + 34
        overlap  = false
        if zoneCnt > 0
            for i = 0 to zoneCnt - 1
                if newStart <= array.get(zoneEnds, i) and newEnd >= array.get(zoneStarts, i)
                    overlap := true
        if showVLines and not overlap
            vline21 := line.new(x1 = newStart, y1 = low, x2 = newStart, y2 = high,
                         extend = extend.both, color = vline21Color, style = lineStyle)
            vline34 := line.new(x1 = newEnd, y1 = low, x2 = newEnd, y2 = high,
                         extend = extend.both, color = vline34Color, style = lineStyle)
            array.push(zoneStarts, newStart)
            array.push(zoneEnds, newEnd)
            linesLive := true
    else if zeroCross and linesLive
        line.delete(vline21)
        line.delete(vline34)
        array.pop(zoneStarts)
        array.pop(zoneEnds)
        linesLive := false
    else if colorChange
        cPending := false
