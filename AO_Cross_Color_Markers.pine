// This Pine Script™ code is subject to the terms of the Mozilla Public License 2.0 at https://mozilla.org/MPL/2.0/
// © ao-cross-color-marker-tv

//@version=6
indicator("AO Cross & Color Markers", overlay = false, max_lines_count = 500)

// --- Inputs ---
showZeroCross  = input.bool(true, "Show Zero Cross (0)")
showColorChange = input.bool(true, "Show Color Change (C)")
showSingleBar  = input.bool(true, "Show Single Bar Pattern")
markerColor    = input.color(color.orange, "Marker Color")

// size parameter of plotchar() requires a compile-time constant,
// so we expose it as a set of bool inputs (only one should be true)
useTiny   = input.bool(false, "Size: Tiny")
useNormal = input.bool(false, "Size: Normal")
useLarge  = input.bool(false, "Size: Large")
useHuge   = input.bool(false, "Size: Huge")

aoAvgLen        = input.int(100, "AO Average Lookback", minval = 10)
aoDisplayAvgLen = input.int(1000, "AO Display Average Lookback", minval = 10)
aoWmaLen        = input.int(14, "AO WMA Length", minval = 1)

showVLines   = input.bool(true, "Show Vertical Lines (C+21, C+34)")
vlineBullColor = input.color(color.green, "VLine Bull Color (cross up)")
vlineBearColor = input.color(color.red, "VLine Bear Color (cross down)")
vlineStyleIn = input.string("dashed", "VLine Style", options = ["solid", "dashed", "dotted"])

tf1Enable = input.bool(false, "TF1 Enable", group = "Multi-TF Alerts")
tf1       = input.timeframe("60", "TF1 Timeframe", group = "Multi-TF Alerts")
tf2Enable = input.bool(false, "TF2 Enable", group = "Multi-TF Alerts")
tf2       = input.timeframe("240", "TF2 Timeframe", group = "Multi-TF Alerts")
tf3Enable = input.bool(false, "TF3 Enable", group = "Multi-TF Alerts")
tf3       = input.timeframe("D", "TF3 Timeframe", group = "Multi-TF Alerts")
tf4Enable = input.bool(false, "TF4 Enable", group = "Multi-TF Alerts")
tf4       = input.timeframe("W", "TF4 Timeframe", group = "Multi-TF Alerts")

lineStyle = switch vlineStyleIn
    "solid"  => line.style_solid
    "dashed" => line.style_dashed
    "dotted" => line.style_dotted

// --- AO Calculation ---
ao = ta.sma(hl2, 5) - ta.sma(hl2, 34)
aoWma = ta.wma(ao, aoWmaLen)

// --- AO Histogram ---
plot(ao, "AO", style = plot.style_histogram, color = ao > ao[1] ? color.green : color.red)
plot(aoWma, "AO WMA", color = color.blue)
hline(0, "Zero", color = color.gray)

// --- AO Display Averages (positive / negative over aoDisplayAvgLen bars) ---
sumDispPos = 0.0
cntDispPos = 0
sumDispNeg = 0.0
cntDispNeg = 0
for i = 0 to aoDisplayAvgLen - 1
    val = ao[i]
    if not na(val)
        if val > 0
            sumDispPos += val
            cntDispPos += 1
        else if val < 0
            sumDispNeg += val
            cntDispNeg += 1

avgDispPos = cntDispPos > 0 ? sumDispPos / cntDispPos : na
avgDispNeg = cntDispNeg > 0 ? sumDispNeg / cntDispNeg : na

plot(avgDispPos, "Avg Positive AO", color = color.green, linewidth = 1)
plot(avgDispNeg, "Avg Negative AO", color = color.red, linewidth = 1)

// --- Zero Cross Signal ---
// AO crossed zero between bar [2] and bar [1] (last closed bar)
zeroCrossUp   = ao[1] > 0 and ao[2] <= 0
zeroCrossDown = ao[1] < 0 and ao[2] >= 0
zeroCross     = zeroCrossUp or zeroCrossDown

// --- AO Average (separate for positive / negative) ---
sumPos = 0.0
cntPos = 0
sumNeg = 0.0
cntNeg = 0
for i = 1 to aoAvgLen
    val = ao[i]
    if not na(val)
        if val > 0
            sumPos += val
            cntPos += 1
        else if val < 0
            sumNeg += val
            cntNeg += 1

avgPos = cntPos > 0 ? sumPos / cntPos : na
avgNeg = cntNeg > 0 ? sumNeg / cntNeg : na

// --- Color Change Signal ---
// AO bar color: green when rising (ao > prev ao), red when falling
colorNow      = ao[1] > ao[2] ? 1 : ao[1] < ao[2] ? -1 : 0
colorPrev     = ao[2] > ao[3] ? 1 : ao[2] < ao[3] ? -1 : 0
colorPrevPrev = ao[3] > ao[4] ? 1 : ao[3] < ao[4] ? -1 : 0
colorChangeRaw = colorNow != colorPrev and colorNow != 0 and colorPrev != 0

singleBar = colorPrevPrev != 0 and colorPrev != 0 and colorNow != 0 and colorPrev != colorPrevPrev and colorPrev != colorNow and colorPrevPrev == colorNow

aoAtC   = ao[1]
strongC = false
if aoAtC > 0 and not na(avgPos)
    strongC := math.abs(aoAtC) >= math.abs(avgPos)
else if aoAtC < 0 and not na(avgNeg)
    strongC := math.abs(aoAtC) >= math.abs(avgNeg)

colorChange = colorChangeRaw and strongC

// --- Draw Markers ---
// One plotchar per size level; only the matching pair is visible.
// Default is size.small when no size toggle is enabled.
showZero  = showZeroCross and zeroCross
showColor = showColorChange and colorChange

plotchar(useTiny and showZero,                                          char = '0', location = location.belowbar, color = markerColor, size = size.tiny,   title = "Zero Cross (tiny)",   offset = -1, force_overlay = true)
plotchar(not useTiny and not useNormal and not useLarge and not useHuge and showZero, char = '0', location = location.belowbar, color = markerColor, size = size.small,  title = "Zero Cross (small)",  offset = -1, force_overlay = true)
plotchar(useNormal and showZero,                                        char = '0', location = location.belowbar, color = markerColor, size = size.normal, title = "Zero Cross (normal)", offset = -1, force_overlay = true)
plotchar(useLarge and showZero,                                         char = '0', location = location.belowbar, color = markerColor, size = size.large,  title = "Zero Cross (large)",  offset = -1, force_overlay = true)
plotchar(useHuge and showZero,                                          char = '0', location = location.belowbar, color = markerColor, size = size.huge,   title = "Zero Cross (huge)",   offset = -1, force_overlay = true)

plotchar(useTiny and showColor,                                          char = 'C', location = location.belowbar, color = markerColor, size = size.tiny,   title = "Color Change (tiny)",   offset = -1, force_overlay = true)
plotchar(not useTiny and not useNormal and not useLarge and not useHuge and showColor, char = 'C', location = location.belowbar, color = markerColor, size = size.small,  title = "Color Change (small)",  offset = -1, force_overlay = true)
plotchar(useNormal and showColor,                                        char = 'C', location = location.belowbar, color = markerColor, size = size.normal, title = "Color Change (normal)", offset = -1, force_overlay = true)
plotchar(useLarge and showColor,                                         char = 'C', location = location.belowbar, color = markerColor, size = size.large,  title = "Color Change (large)",  offset = -1, force_overlay = true)
plotchar(useHuge and showColor,                                          char = 'C', location = location.belowbar, color = markerColor, size = size.huge,   title = "Color Change (huge)",   offset = -1, force_overlay = true)

// --- Single Bar Pattern Arrows (on AO pane) ---
aoArrowOffset = ta.highest(math.abs(ao), 100) * 0.20
plotshape(showSingleBar and singleBar and ao[2] > 0 ? ao[2] + aoArrowOffset : na,
          style = shape.triangledown, location = location.absolute,
          color = color.red, size = size.tiny, offset = -2,
          title = "Single Bar Down")
plotshape(showSingleBar and singleBar and ao[2] < 0 ? ao[2] - aoArrowOffset : na,
          style = shape.triangleup, location = location.absolute,
          color = color.green, size = size.tiny, offset = -2,
          title = "Single Bar Up")

// --- Vertical Lines: C+21 / C+34 ---
var int   lastCBar      = na
var bool  cPending      = false
var float lastAoAtC     = na
var line vline21       = na
var line vline34       = na
var bool linesLive        = false
var int  liveZoneStart    = na
var int  liveZoneEnd      = na
var bool preZoneProtected = false

var array<int> zoneStarts = array.new<int>()
var array<int> zoneEnds   = array.new<int>()

signalBar = bar_index - 1
inZone    = false
zoneCnt   = array.size(zoneStarts)
if zoneCnt > 0
    for i = 0 to zoneCnt - 1
        if signalBar >= array.get(zoneStarts, i) and signalBar <= array.get(zoneEnds, i)
            inZone := true

// Phase 1: manage live lines
if linesLive
    if signalBar > liveZoneEnd
        linesLive := false
    else if zeroCross and signalBar >= liveZoneStart and signalBar <= liveZoneEnd
        line.delete(vline21)
        line.delete(vline34)
        array.pop(zoneStarts)
        array.pop(zoneEnds)
        linesLive := false
    else if zeroCross and signalBar < liveZoneStart and not preZoneProtected
        line.delete(vline21)
        line.delete(vline34)
        array.pop(zoneStarts)
        array.pop(zoneEnds)
        linesLive := false
    else if colorChange and signalBar < liveZoneStart
        preZoneProtected := true

// Phase 2: new pair logic (only outside zones)
if not inZone
    if colorChange and not zeroCross
        lastCBar  := bar_index - 1
        cPending  := true
        lastAoAtC := ao[1]
    else if zeroCross and cPending
        cPending := false
        if not linesLive
            newStart = lastCBar + 21
            newEnd   = lastCBar + 34
            zeroInOwnZone = signalBar >= newStart and signalBar <= newEnd
            overlap  = false
            if zoneCnt > 0
                for i = 0 to zoneCnt - 1
                    if newStart <= array.get(zoneEnds, i) and newEnd >= array.get(zoneStarts, i)
                        overlap := true
            if showVLines and not overlap and not zeroInOwnZone
                vlineColor = lastAoAtC > 0 ? vlineBullColor : vlineBearColor
                vline21 := line.new(x1 = newStart, y1 = low, x2 = newStart, y2 = high,
                             extend = extend.both, color = vlineColor, style = lineStyle, force_overlay = true)
                vline34 := line.new(x1 = newEnd, y1 = low, x2 = newEnd, y2 = high,
                             extend = extend.both, color = vlineColor, style = lineStyle, force_overlay = true)
                array.push(zoneStarts, newStart)
                array.push(zoneEnds, newEnd)
                liveZoneStart    := newStart
                liveZoneEnd      := newEnd
                linesLive        := true
                preZoneProtected := false
    else if colorChange
        cPending := false

// --- MTF Alert Signal Function ---
calcAlertSignals(wmaLen) =>
    _ao    = ta.sma(hl2, 5) - ta.sma(hl2, 34)
    _aoWma = ta.wma(_ao, wmaLen)

    _zeroCrossUp   = _ao[1] > 0 and _ao[2] <= 0
    _zeroCrossDown = _ao[1] < 0 and _ao[2] >= 0

    _colorNow      = _ao[1] > _ao[2] ? 1 : _ao[1] < _ao[2] ? -1 : 0
    _colorPrev     = _ao[2] > _ao[3] ? 1 : _ao[2] < _ao[3] ? -1 : 0
    _colorPrevPrev = _ao[3] > _ao[4] ? 1 : _ao[3] < _ao[4] ? -1 : 0

    _singleBar = _colorPrevPrev != 0 and _colorPrev != 0 and _colorNow != 0 and _colorPrev != _colorPrevPrev and _colorPrev != _colorNow and _colorPrevPrev == _colorNow
    _singleBarDown = _singleBar and _ao[2] > 0
    _singleBarUp   = _singleBar and _ao[2] < 0

    _saucerBuy  = _ao[1] > 0 and _ao[2] > 0 and _colorPrev == -1 and _colorNow == 1
    _saucerSell = _ao[1] < 0 and _ao[2] < 0 and _colorPrev == 1  and _colorNow == -1

    _wmaCrossUp   = _ao[1] > _aoWma[1] and _ao[2] <= _aoWma[2]
    _wmaCrossDown = _ao[1] < _aoWma[1] and _ao[2] >= _aoWma[2]

    var float _prevPeakPos    = na
    var float _currPeakPos    = 0.0
    var bool  _peakAlertedPos = false
    var float _prevPeakNeg    = na
    var float _currPeakNeg    = 0.0
    var bool  _peakAlertedNeg = false

    if _ao[1] > 0
        _currPeakPos := math.max(_currPeakPos, _ao[1])
    if _ao[1] < 0
        _currPeakNeg := math.min(_currPeakNeg, _ao[1])

    if _zeroCrossUp
        _prevPeakNeg    := _currPeakNeg
        _currPeakNeg    := 0.0
        _peakAlertedNeg := false
        _currPeakPos    := 0.0
        _peakAlertedPos := false
    if _zeroCrossDown
        _prevPeakPos    := _currPeakPos
        _currPeakPos    := 0.0
        _peakAlertedPos := false
        _currPeakNeg    := 0.0
        _peakAlertedNeg := false

    _newHigherPeak = _ao[1] > 0 and not na(_prevPeakPos) and _currPeakPos > _prevPeakPos and not _peakAlertedPos
    _newLowerPeak  = _ao[1] < 0 and not na(_prevPeakNeg) and _currPeakNeg < _prevPeakNeg and not _peakAlertedNeg

    if _newHigherPeak
        _peakAlertedPos := true
    if _newLowerPeak
        _peakAlertedNeg := true

    [_saucerBuy, _saucerSell, _wmaCrossUp, _wmaCrossDown, _newHigherPeak, _newLowerPeak, _singleBarDown, _singleBarUp]

// --- Current TF Alerts ---
saucerBuy  = ao[1] > 0 and ao[2] > 0 and colorPrev == -1 and colorNow == 1
saucerSell = ao[1] < 0 and ao[2] < 0 and colorPrev == 1 and colorNow == -1

wmaCrossUp   = ao[1] > aoWma[1] and ao[2] <= aoWma[2]
wmaCrossDown = ao[1] < aoWma[1] and ao[2] >= aoWma[2]

var float prevPeakPos    = na
var float currPeakPos    = 0.0
var bool  peakAlertedPos = false
var float prevPeakNeg    = na
var float currPeakNeg    = 0.0
var bool  peakAlertedNeg = false

if ao[1] > 0
    currPeakPos := math.max(currPeakPos, ao[1])
if ao[1] < 0
    currPeakNeg := math.min(currPeakNeg, ao[1])

if zeroCrossUp
    prevPeakNeg    := currPeakNeg
    currPeakNeg    := 0.0
    peakAlertedNeg := false
    currPeakPos    := 0.0
    peakAlertedPos := false
if zeroCrossDown
    prevPeakPos    := currPeakPos
    currPeakPos    := 0.0
    peakAlertedPos := false
    currPeakNeg    := 0.0
    peakAlertedNeg := false

newHigherPeak = ao[1] > 0 and not na(prevPeakPos) and currPeakPos > prevPeakPos and not peakAlertedPos
newLowerPeak  = ao[1] < 0 and not na(prevPeakNeg) and currPeakNeg < prevPeakNeg and not peakAlertedNeg

if newHigherPeak
    peakAlertedPos := true
if newLowerPeak
    peakAlertedNeg := true

singleBarDown = singleBar and ao[2] > 0
singleBarUp   = singleBar and ao[2] < 0

// --- Fetch MTF Signals ---
[tf1SB, tf1SS, tf1WCU, tf1WCD, tf1HP, tf1LP, tf1SBD, tf1SBU] = request.security(syminfo.tickerid, tf1, calcAlertSignals(aoWmaLen))
[tf2SB, tf2SS, tf2WCU, tf2WCD, tf2HP, tf2LP, tf2SBD, tf2SBU] = request.security(syminfo.tickerid, tf2, calcAlertSignals(aoWmaLen))
[tf3SB, tf3SS, tf3WCU, tf3WCD, tf3HP, tf3LP, tf3SBD, tf3SBU] = request.security(syminfo.tickerid, tf3, calcAlertSignals(aoWmaLen))
[tf4SB, tf4SS, tf4WCU, tf4WCD, tf4HP, tf4LP, tf4SBD, tf4SBU] = request.security(syminfo.tickerid, tf4, calcAlertSignals(aoWmaLen))

// --- Combined Multi-TF alertcondition() ---
anySaucerBuy  = saucerBuy  or (tf1Enable and tf1SB)  or (tf2Enable and tf2SB)  or (tf3Enable and tf3SB)  or (tf4Enable and tf4SB)
anySaucerSell = saucerSell or (tf1Enable and tf1SS)  or (tf2Enable and tf2SS)  or (tf3Enable and tf3SS)  or (tf4Enable and tf4SS)
anyWmaCrossUp   = wmaCrossUp   or (tf1Enable and tf1WCU) or (tf2Enable and tf2WCU) or (tf3Enable and tf3WCU) or (tf4Enable and tf4WCU)
anyWmaCrossDown = wmaCrossDown or (tf1Enable and tf1WCD) or (tf2Enable and tf2WCD) or (tf3Enable and tf3WCD) or (tf4Enable and tf4WCD)
anyHigherPeak = newHigherPeak or (tf1Enable and tf1HP) or (tf2Enable and tf2HP) or (tf3Enable and tf3HP) or (tf4Enable and tf4HP)
anyLowerPeak  = newLowerPeak  or (tf1Enable and tf1LP) or (tf2Enable and tf2LP) or (tf3Enable and tf3LP) or (tf4Enable and tf4LP)

alertcondition(anySaucerBuy,    title = "AO Saucer Buy (Multi-TF)",    message = "AO Saucer BUY on one or more timeframes")
alertcondition(anySaucerSell,   title = "AO Saucer Sell (Multi-TF)",   message = "AO Saucer SELL on one or more timeframes")
alertcondition(anyWmaCrossUp,   title = "AO WMA Cross Up (Multi-TF)",  message = "AO crossed ABOVE WMA on one or more timeframes")
alertcondition(anyWmaCrossDown, title = "AO WMA Cross Down (Multi-TF)", message = "AO crossed BELOW WMA on one or more timeframes")
alertcondition(anyHigherPeak,   title = "AO Higher Peak (Multi-TF)",   message = "AO higher peak on one or more timeframes")
alertcondition(anyLowerPeak,    title = "AO Lower Peak (Multi-TF)",    message = "AO lower peak on one or more timeframes")

anySingleBarDown = singleBarDown or (tf1Enable and tf1SBD) or (tf2Enable and tf2SBD) or (tf3Enable and tf3SBD) or (tf4Enable and tf4SBD)
anySingleBarUp   = singleBarUp  or (tf1Enable and tf1SBU) or (tf2Enable and tf2SBU) or (tf3Enable and tf3SBU) or (tf4Enable and tf4SBU)

alertcondition(anySingleBarDown, title = "AO Single Bar Down (Multi-TF)", message = "AO single bar bearish pattern on one or more timeframes")
alertcondition(anySingleBarUp,   title = "AO Single Bar Up (Multi-TF)",   message = "AO single bar bullish pattern on one or more timeframes")

// --- Per-TF alert() with dynamic messages ---
chartTf = timeframe.period

if saucerBuy
    alert("AO Saucer BUY on " + chartTf, alert.freq_once_per_bar_close)
if saucerSell
    alert("AO Saucer SELL on " + chartTf, alert.freq_once_per_bar_close)
if wmaCrossUp
    alert("AO crossed ABOVE WMA on " + chartTf, alert.freq_once_per_bar_close)
if wmaCrossDown
    alert("AO crossed BELOW WMA on " + chartTf, alert.freq_once_per_bar_close)
if newHigherPeak
    alert("AO higher peak on " + chartTf, alert.freq_once_per_bar_close)
if newLowerPeak
    alert("AO lower peak on " + chartTf, alert.freq_once_per_bar_close)
if singleBarDown
    alert("AO single bar DOWN on " + chartTf, alert.freq_once_per_bar_close)
if singleBarUp
    alert("AO single bar UP on " + chartTf, alert.freq_once_per_bar_close)

if tf1Enable and tf1SB
    alert("AO Saucer BUY on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1SS
    alert("AO Saucer SELL on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1WCU
    alert("AO crossed ABOVE WMA on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1WCD
    alert("AO crossed BELOW WMA on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1HP
    alert("AO higher peak on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1LP
    alert("AO lower peak on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1SBD
    alert("AO single bar DOWN on " + tf1, alert.freq_once_per_bar_close)
if tf1Enable and tf1SBU
    alert("AO single bar UP on " + tf1, alert.freq_once_per_bar_close)

if tf2Enable and tf2SB
    alert("AO Saucer BUY on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2SS
    alert("AO Saucer SELL on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2WCU
    alert("AO crossed ABOVE WMA on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2WCD
    alert("AO crossed BELOW WMA on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2HP
    alert("AO higher peak on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2LP
    alert("AO lower peak on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2SBD
    alert("AO single bar DOWN on " + tf2, alert.freq_once_per_bar_close)
if tf2Enable and tf2SBU
    alert("AO single bar UP on " + tf2, alert.freq_once_per_bar_close)

if tf3Enable and tf3SB
    alert("AO Saucer BUY on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3SS
    alert("AO Saucer SELL on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3WCU
    alert("AO crossed ABOVE WMA on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3WCD
    alert("AO crossed BELOW WMA on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3HP
    alert("AO higher peak on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3LP
    alert("AO lower peak on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3SBD
    alert("AO single bar DOWN on " + tf3, alert.freq_once_per_bar_close)
if tf3Enable and tf3SBU
    alert("AO single bar UP on " + tf3, alert.freq_once_per_bar_close)

if tf4Enable and tf4SB
    alert("AO Saucer BUY on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4SS
    alert("AO Saucer SELL on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4WCU
    alert("AO crossed ABOVE WMA on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4WCD
    alert("AO crossed BELOW WMA on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4HP
    alert("AO higher peak on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4LP
    alert("AO lower peak on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4SBD
    alert("AO single bar DOWN on " + tf4, alert.freq_once_per_bar_close)
if tf4Enable and tf4SBU
    alert("AO single bar UP on " + tf4, alert.freq_once_per_bar_close)
